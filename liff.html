<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>讀取中...</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0;
            background-color: #f8f9fa; font-family: sans-serif; flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <p>正在跳轉至外部瀏覽器...</p>

    <script>
        // === 設定區 ===
        // 請填入您的 LIFF ID
        const LIFF_ID = '2004052594-jdwXq4HB'; 
        // 請填入第一步部署的 GAS Web App URL
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxyf_TSLu5fA-zF9yew6wkdb1O5maBGlicBbczUrdjVIMnMOIPYuzT4tZtW0uj8eJmk_Q/exec'; 

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const uid = profile.userId;

                // 取得網址參數中的 pushId (例如: liff.html?pushId=123)
                const urlParams = new URLSearchParams(window.location.search);
                const pushId = urlParams.get('pushId');

                if (!pushId) {
                    alert('參數錯誤：缺少 Push ID');
                    return;
                }

                // 組裝 GAS 查詢網址
                // GAS 會執行資料查詢後，Redirect 到 index.html
                const redirectUrl = `${GAS_URL}?action=redirect_user&uid=${encodeURIComponent(uid)}&pushId=${encodeURIComponent(pushId)}`;

                // === 關鍵 ===
                // 使用 external: true 強制開啟外部瀏覽器 (Safari/Chrome)
                // 這樣下載功能才不會被 LINE 內建瀏覽器擋住
                liff.openWindow({
                    url: redirectUrl,
                    external: true
                });

                // 關閉 LIFF 視窗 (可選，讓體驗更順暢)
                // liff.closeWindow(); 

            } catch (err) {
                console.error('LIFF Error:', err);
                document.querySelector('p').innerText = '發生錯誤，請重新整理';
                alert('初始化失敗：' + err.message);
            }
        }

        main();
    </script>
</body>
</html>
